'Copyright (c) 2007-2011 Bo Morgan.
 All rights reserved.
 
 Author: Bo Morgan
 
 Permission to use, copy, modify and distribute this software and its
 documentation is hereby granted, provided that both the copyright
 notice and this permission notice appear in all copies of the
 software, derivative works or modified versions, and any portions
 thereof, and that both notices appear in supporting documentation.
 
 BO MORGAN ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS" CONDITION.
 BO MORGAN DISCLAIMS ANY LIABILITY OF ANY KIND FOR ANY DAMAGES
 WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 
 Bo Morgan requests users of this software to return to bo@mit.edu any
 improvements or extensions that they make and grant Bo Morgan the
 rights to redistribute these changes.'


[deframe isismon_define_object_dialog [frame] [[object        nil]
					       [object_type   nil]
					       [window        [gtk-window-new]]
					       [vbox          [gtk-vbox-new 2]]
					       [label         nil]
					       [entry         [gtk-entry-new]]
					       [hbox          [gtk-hbox-new 2]]
					       [cancel_button [gtk-button-new_with_label 'Cancel']]
					       [okay_button   [gtk-button-new_with_label 'Okay']]
					       [done          nil]]
  [new [define_object define_object_type]
       [= object      define_object]
       [= object_type define_object_type]
       [= label       [gtk-label-new [format nil 'You have chosen to define this ' object_type '.\nPlease enter a global name for this ' object_type '.']]]
       [set  window title 'IsisMon - define ' object_type ' dialog']
       [have window connect_hide_on_delete]
       [have window add vbox]
       [have vbox pack_start label nil nil 0]
       [have vbox pack_start entry nil nil 0]
       [have vbox pack_start hbox  nil nil 0]
       [have hbox pack_start cancel_button nil nil 0]
       [have hbox pack_start okay_button   nil nil 0]
       [have cancel_button signal_connect 'clicked'
	     [funk []
		   [= done t]]
	     nil]
       [have okay_button signal_connect 'clicked'
	     [funk []
		   [have this define_and_close]]
	     nil]
       [have entry key_press_event-signal_connect
	     [funk [key_event]
		   [let [[keyval [have key_event lookup `keyval]]]
		     [if [eq keyval GDK_Return]
			 [have this define_and_close]]]]
	     nil]
       
       [have window show_all]
       [fiber [funk []
		    [while [and [get window visible] [not done]]
		      [sleep 1]]
		    [have window destroy]]
	      nil]
       ]]

[deftypefunk isismon_define_object_dialog execute define_and_close []
  [let [[object_name [get [get entry text] as-symbol]]]
    [terminal_format standard-terminal '\nDefining ' object_type ' as ' object_name '.\n']
    [eval `[globalize ,object_name ,object]]]
  [= done t]]



[deframe isismon_agent_resource_menu [frame] [isismon_agent_agency_menu
					      resource
					      
					      resource_menu_item
					      resource_menu
					      
					      debugging_mode_check_menu_item
					      print_to_terminal_menu_item
					      define_globally_menu_item
					      ]
  [new [initial-isismon_agent_agency_menu initial-resource]
       [= isismon_agent_agency_menu initial-isismon_agent_agency_menu]
       [= resource                  initial-resource]
       
       [= resource_menu_item [gtk-menu_item-new [format nil [get resource name] ' Resource']]]
       [= resource_menu      [gtk-menu-new]]
       [set resource_menu_item submenu resource_menu]
       
       [= debugging_mode_check_menu_item [gtk-check_menu_item-new 'Debugging Mode']]
       [have resource_menu append debugging_mode_check_menu_item]
       
       [have debugging_mode_check_menu_item signal_connect 'toggled'
	     [funk []
		   [set this debug_all [get debugging_mode_check_menu_item active]]]
	     nil]
       
       [= print_to_terminal_menu_item [gtk-menu_item-new 'Print to Terminal']]
       [have print_to_terminal_menu_item signal_connect 'activate'
	     [funk []
		   [terminal_format standard-terminal '\n' resource]]
	     nil]
       [have resource_menu append print_to_terminal_menu_item]
       
       [= define_globally_menu_item [gtk-menu_item-new 'Define Globally']]
       [have define_globally_menu_item signal_connect 'activate'
	     [funk []
		   [get isismon_define_object_dialog resource `resource]]
	     nil]
       [have resource_menu append define_globally_menu_item]
       
       ]]

[deftypefunk isismon_agent_resource_menu get widget []
  resource_menu_item]

[deftypefunk isismon_agent_resource_menu set debug_all [debug]
  [terminal_format standard-terminal '\n' [if debug 'Enabling' 'Disabling'] ' debugging mode for ' [get [get resource mind] name] '\'s ' [get resource name] ' resource.']
  [set debugging_mode_check_menu_item active debug]
  [set resource debug debug]]


[deframe isismon_agent_agency_menu [frame] [isismon_agent_layer_menu
					    agency
					    
					    agency_menu_item
					    agency_menu
					    
					    enable_debugging_all_menu_item
					    disable_debugging_all_menu_item
					    
					    isismon_resource_menus
					    ]
  [new [initial-isismon_agent_layer_menu initial-agency]
       [= isismon_agent_layer_menu initial-isismon_agent_layer_menu]
       [= agency                   initial-agency]
       
       [= agency_menu_item [gtk-menu_item-new [format nil [get agency name] ' Agency']]]
       [= agency_menu      [gtk-menu-new]]
       [set agency_menu_item submenu agency_menu]
       
       [= enable_debugging_all_menu_item [gtk-menu_item-new 'Enable Debugging All']]
       [have agency_menu append enable_debugging_all_menu_item]
       [have enable_debugging_all_menu_item signal_connect 'activate'
	     [funk []
		   [set this debug_all t]]
	     nil]
       
       [= disable_debugging_all_menu_item [gtk-menu_item-new 'Disable Debugging All']]
       [have agency_menu append disable_debugging_all_menu_item]
       [have disable_debugging_all_menu_item signal_connect 'activate'
	     [funk []
		   [set this debug_all nil]]
	     nil]
       
       [mapc [funk [resource]
		   [let [[isismon_resource_menu [new isismon_agent_resource_menu this resource]]]
		     [= isismon_resource_menus [cons isismon_resource_menu isismon_resource_menus]]
		     [have agency_menu append isismon_resource_menu]]]
	     [get agency resources]]
       
       ]]

[deftypefunk isismon_agent_agency_menu get widget []
  agency_menu_item]

[deftypefunk isismon_agent_agency_menu set debug_all [debug]
  [mapc [funk [isismon_resource_menu]
	      [set isismon_resource_menu debug_all debug]]
	isismon_resource_menus]]



[deframe isismon_agent_layer_menu [frame] [isismon_agent_mind_menu
					   layer
					   
					   layer_menu_item
					   layer_menu
					   
					   enable_debugging_all_menu_item
					   disable_debugging_all_menu_item
					   
					   isismon_agency_menus
					   ]
  [new [initial-isismon_agent_mind_menu initial-layer]
       [= isismon_agent_mind_menu initial-isismon_agent_mind_menu]
       [= layer                   initial-layer]
       
       [= layer_menu_item [gtk-menu_item-new [format nil [get layer name] ' Layer']]]
       [= layer_menu      [gtk-menu-new]]
       [set layer_menu_item submenu layer_menu]
       
       [= enable_debugging_all_menu_item [gtk-menu_item-new 'Enable Debugging All']]
       [have layer_menu append enable_debugging_all_menu_item]
       [have enable_debugging_all_menu_item signal_connect 'activate'
	     [funk []
		   [set this debug_all t]]
	     nil]
       
       [= disable_debugging_all_menu_item [gtk-menu_item-new 'Disable Debugging All']]
       [have layer_menu append disable_debugging_all_menu_item]
       [have disable_debugging_all_menu_item signal_connect 'activate'
	     [funk []
		   [set this debug_all nil]]
	     nil]
       
       [mapc [funk [agency]
		   [let [[isismon_agency_menu [new isismon_agent_agency_menu this agency]]]
		     [= isismon_agency_menus [cons isismon_agency_menu isismon_agency_menus]]
		     [have layer_menu append isismon_agency_menu]]]
	     [get layer agencies]]
       ]]

[deftypefunk isismon_agent_layer_menu get widget []
  layer_menu_item]

[deftypefunk isismon_agent_layer_menu set debug_all [debug]
  [mapc [funk [isismon_agency_menu]
	      [set isismon_agency_menu debug_all debug]]
	isismon_agency_menus]]


[deframe isismon_agent_mind_menu [frame] [isismon_agent
					  
					  mind_menu_item
					  mind_menu
					  
					  enable_debugging_all_menu_item
					  disable_debugging_all_menu_item
					  
					  isismon_layer_menus
					  ]
  [new [initial-isismon_agent]
       [= isismon_agent initial-isismon_agent]
       
       [= mind_menu_item [gtk-menu_item-new 'Mind']]
       [= mind_menu      [gtk-menu-new]]
       [set mind_menu_item submenu mind_menu]
       
       [= enable_debugging_all_menu_item [gtk-menu_item-new 'Enable Debugging All']]
       [have mind_menu append enable_debugging_all_menu_item]
       [have enable_debugging_all_menu_item signal_connect 'activate'
	     [funk []
		   [set this debug_all t]]
	     nil]
       
       [= disable_debugging_all_menu_item [gtk-menu_item-new 'Disable Debugging All']]
       [have mind_menu append disable_debugging_all_menu_item]
       [have disable_debugging_all_menu_item signal_connect 'activate'
	     [funk []
		   [set this debug_all nil]]
	     nil]
       
       'We finish creating mind menu in parallel for quicker initial load appearance.'
       [fiber [funk []
		    [mapc [funk [layer]
				[let [[isismon_layer_menu [new isismon_agent_layer_menu this layer]]]
				  [= isismon_layer_menus [cons isismon_layer_menu isismon_layer_menus]]
				  [have [get isismon_layer_menu widget] show_all]
				  [have mind_menu append isismon_layer_menu]]]
			  [have [get [get [get isismon_agent isis_agent] mind] layers] sort [funk [x y] [< [get x index] [get y index]]]]]
		    [have mind_menu_item show_all]
		    ]
	      nil]
       
       nil]]

[deftypefunk isismon_agent_mind_menu get widget []
  mind_menu_item]
				
[deftypefunk isismon_agent_mind_menu set debug_all [debug]
  [mapc [funk [isismon_layer_menu]
	      [set isismon_layer_menu debug_all debug]]
	isismon_layer_menus]]



[deframe isismon_save_agent_dialog [frame] [isismon_agent
					    isismon
					    save_dialog]
  [new [initial-isismon_agent]
       [= isismon_agent initial-isismon_agent]
       [= isismon       [get [get isismon_agent isismon_project] isismon]]
       
       [= save_dialog [gtk-file_chooser_dialog-new_for_file_save [get isismon window]]]
       
       [have save_dialog add_file_filter_pattern 'IsisMon Agent Files (*.isis-agent)' '*.isis-agent']
       [have save_dialog add_file_filter_pattern 'All Files (*.*)'                    '*.*']
       [set  save_dialog current_name 'Untitled Agent.isis-agent']
       [set  save_dialog current_folder [get [get isismon preferences] agent_directory]]
       [have save_dialog response_event-signal_connect
	     [funk [event_frame]
		   [let [[response_id [have event_frame lookup `response_id]]]
		     [if [eq response_id GTK_RESPONSE_ACCEPT]
			 [let [[filename [get save_dialog filename]]]
			   [have save_dialog destroy]
			   [have isismon_agent save filename]]
		       [have save_dialog destroy]]]]
	     nil]
       [have save_dialog show_all]]]


[deframe isismon_agent [frame] [isis_agent
				
				isismon_project
				
				frame
				vbox
				
				menu_bar
				file_menu_item
				file_menu
				file_save_agent_menu_item
				tools_menu
				tools_menu_item
				tools_mindmon_menu_item
				tools_builtin_reactive_physical_activator_menu_item
				tools_learned_reactive_physical_activator_menu_item
				tools_deliberative_goal_activator_menu_item
				view_menu
				view_menu_item
				view_sense_menu_item
				view_perception_menu_item
				view_visual_objects_menu_item
				view_proprioceptual_frame_menu_item
				isismon_agent_mind_menu
				
				entry
				
				[isismon_knowledge_mutex     [new mutex]]
				[isismon_knowledge_ptypehash [new ptypehash]]
				
				]
  [new [initial_isismon_project initial_isis_agent]
       [= isismon_project initial_isismon_project]
       [= isis_agent      initial_isis_agent]
       
       [= frame [gtk-frame-new [format nil 'isis_agent - ' [get isis_agent name]]]]
       [= vbox  [gtk-vbox-new 0]]
       
       [= menu_bar        [gtk-menu_bar-new]]
       [have vbox pack_start menu_bar nil nil 0]
       
       [= file_menu_item            [gtk-menu_item-new 'File']]
       [= file_menu                 [gtk-menu-new]]
       [= file_save_agent_menu_item [gtk-menu_item-new 'Save Agent...']]
       [have file_menu append file_save_agent_menu_item]
       [set file_menu_item submenu file_menu]
       [have menu_bar append file_menu_item]
       
       [have file_save_agent_menu_item signal_connect 'activate'
	     [funk []
		   [new isismon_save_agent_dialog this]]
	     nil]
       
       [= tools_menu      [gtk-menu-new]]
       [= tools_menu_item [gtk-menu_item-new 'Tools']]
       [set tools_menu_item submenu tools_menu]
       [have menu_bar append tools_menu_item]
       
       [= tools_mindmon_menu_item [gtk-menu_item-new 'MindMon']]
       [have tools_mindmon_menu_item signal_connect 'activate'
	     [funk []
		   [terminal_format standard-terminal '\nLaunching MindMon to monitor ' [get this name] '\'s mind.']
		   [mindmon [get isis_agent mind]]]
	     nil]
       [have tools_menu append tools_mindmon_menu_item]
       
       [= tools_builtin_reactive_physical_activator_menu_item [gtk-menu_item-new 'Built-in Reactive Physical Activator']]
       [have tools_builtin_reactive_physical_activator_menu_item signal_connect 'activate'
	     [funk []
		   [terminal_format standard-terminal '\nLaunching built-in reactive physical activator for agent ' [get this name] '.']
		   [new isismon_agent_builtin_reactive_physical_resource_activator this]]
	     nil]
       [have tools_menu append tools_builtin_reactive_physical_activator_menu_item]
       
       [= tools_learned_reactive_physical_activator_menu_item [gtk-menu_item-new 'Learned Reactive Physical Activator']]
       [have tools_learned_reactive_physical_activator_menu_item signal_connect 'activate'
	     [funk []
		   [terminal_format standard-terminal '\nLaunching learned reactive physical activator for agent ' [get this name] '.']
		   [new isismon_agent_learned_reactive_physical_resource_activator this]]
	     nil]
       [have tools_menu append tools_learned_reactive_physical_activator_menu_item]
       
       [= tools_deliberative_goal_activator_menu_item [gtk-menu_item-new 'Deliberative Goal Activator']]
       [have tools_deliberative_goal_activator_menu_item signal_connect 'activate'
	     [funk []
		   [terminal_format standard-terminal '\nLaunching deliberative goal activator for agent ' [get this name] '.']
		   [new isismon_agent_deliberative_goal_resource_activator this]]
	     nil]
       [have tools_menu append tools_deliberative_goal_activator_menu_item]
       
       [= view_menu      [gtk-menu-new]]
       [= view_menu_item [gtk-menu_item-new 'View']]
       [set view_menu_item submenu view_menu]
       [have menu_bar append view_menu_item]
       
       [= view_sense_menu_item [gtk-menu_item-new 'Sense']]
       [have view_sense_menu_item signal_connect 'activate'
	     [funk []
		   [format stdout '\n' [get this name] '\'s sensory information:'
			   '\n  ' [have isis_agent sense_world]]]
	     nil]
       [have view_menu append view_sense_menu_item]
       
       [= view_perception_menu_item [gtk-menu_item-new 'Perception']]
       [have view_perception_menu_item signal_connect 'activate'
	     [funk []
		   [let [[perception [get [get isis_agent mind] perception]]]
		     [if [null perception]
			 [format stdout '\n' [get this name] '\'s has no perception']
		       [format stdout '\n' [get this name] '\'s perception:'
			       '\n  ' [get [get isis_agent mind] perception]]]]]
	     nil]
       [have view_menu append view_perception_menu_item]
       
       [= view_proprioceptual_frame_menu_item [gtk-menu_item-new 'Proprioceptual Frame']]
       [have view_proprioceptual_frame_menu_item signal_connect 'activate'
	     [funk []
		   [let [[perception [get [get isis_agent mind] perception]]]
		     [if [null perception]
			 [format stdout '\n' [get this name] '\'s has no perception']
		       [format stdout '\n' [get this name] '\'s proprioceptual frame:'
			       '\n  ' [have [get [get isis_agent mind] perception] lookup `proprioceptual_frame]]]]]
	     nil]
       [have view_menu append view_proprioceptual_frame_menu_item]
       
       [= view_visual_objects_menu_item [gtk-menu_item-new 'Visual Objects']]
       [have view_visual_objects_menu_item signal_connect 'activate'
	     [funk []
		   [let [[perception [get [get isis_agent mind] perception]]]
		     [if [null perception]
			 [format stdout '\n' [get this name] '\'s has no perception']
		       [format stdout '\n' [get this name] '\'s visual objects:'
			       '\n  ' [have perception lookup `visual_objects]]]]]
	     nil]
       [have view_menu append view_visual_objects_menu_item]
       
       [= isismon_agent_mind_menu [new isismon_agent_mind_menu this]]
       [have menu_bar append isismon_agent_mind_menu]
       
       
       [= entry [gtk-entry-new]]
       
       [have entry key_press_event-signal_connect
	     [funk [key_event]
		   [let [[keyval [have key_event lookup `keyval]]]
		     `[terminal_format standard-terminal '\nkey event: ' key_event]
		     [if [eq keyval GDK_Return]
			 [let [[text [get entry text]]]
			   [set entry text '']
			   [let [[strings [have text split ' ']]]
			     [let [[reverse_symbols nil]]
			       [mapc [funk [string]
					   [if [not [equals string '']]
					       [= reverse_symbols [cons [get string as-symbol] reverse_symbols]]]]
				     strings]
			       [let [[symbols [reverse reverse_symbols]]]
				 [terminal_format standard-terminal '\nSending symbols, ' symbols ', through ' [get isis_agent name] '\'s neural plug.']
				 [let [[activate_resource [get [get isis_agent mind] resource `builtin_reactive `neural_plug `activate_resource]]]
				   [have activate_resource command `learned_reactive `language `speak_language [append `[I hear] symbols `[from nil]]]
				   [have activate_resource command `learned_reactive `language `hear_language_from_agent nil symbols]
				   ]]]]]]]]
	     nil]
       
       [have vbox pack_start entry nil nil 0]
       
       [fiber [funk []
		    [have this add_isismon_knowledge `other_agents_knowledge]
		    [have this add_isismon_knowledge `goal_event_knowledge]
		    [have this add_isismon_knowledge `goal_knowledge]
		    [have this add_isismon_knowledge `old_reflective_event_knowledge]
		    [have this add_isismon_knowledge `old_reflective_knowledge]
		    [have this add_isismon_knowledge `physical_type_event_knowledge]
		    [have this add_isismon_knowledge `physical_type_knowledge]
		    [have this add_isismon_knowledge `physical_event_knowledge]
		    [have this add_isismon_knowledge `physical_knowledge]
		    [have this add_isismon_knowledge `visual_knowledge]
		    
		    [mapc [funk [semantic_knowledge_base]
				[let [[name [get semantic_knowledge_base name]]]
				  [if [not [get isismon_knowledge_ptypehash contains name]]
				      [have this add_isismon_knowledge name]]]]
			  [get [get isis_agent mind] semantic_knowledge_bases]]
		    
		    [have [get isis_agent mind] add_semantic_knowledge_base_add_event_callback_funk [funk [semantic_knowledge_base]
													  [let [[name [get semantic_knowledge_base name]]]
													    [have this add_isismon_knowledge name]]]]
		    
		    [have [get this widget] show_all]
		    [have this update]
		    ]
	      nil]
       
       [have frame add vbox]
       nil]]

[deftypefunk isismon_agent execute add_isismon_knowledge [isismon_knowledge_name]
  [have isismon_knowledge_mutex lock]
  [let [[isismon_knowledge [new isismon_knowledge this isismon_knowledge_name]]]
    [have isismon_knowledge_ptypehash add isismon_knowledge_name isismon_knowledge]
    [have vbox pack_start isismon_knowledge nil nil 0]]
  [have isismon_knowledge_mutex unlock]]

[defunk isismon_agent-new_from_name [isismon_project name]
  [let [[moral_compass [new moral_compass]]]
    [terminal_format standard-terminal '\nisismon_agent-new_from_name creating isis_agent_body.']
    [let [[isis_agent [new isis_agent_body [get isismon_project isis_world] moral_compass name]]]
      [terminal_format standard-terminal '\nisismon_agent-new_from_name added mind to body.']
      [have moral_compass activate_vital_resources]
      [new isismon_agent isismon_project isis_agent]]]]

[deftypefunk isismon_agent get name []
  [get isis_agent name]]

[deftypefunk isismon_agent get widget []
  frame]

[deftypefunk isismon_agent get window []
  [get isismon_project window]]

[deftypefunk isismon_agent execute update_entry []
  [let [[look_for_resource [get [get isis_agent mind] resource `learned_reactive `physical `look_for]]]
    [set entry text [format nil 'look_for-current_object: \t' [have look_for_resource lookup `my_current_object]]]
    ]]

[deftypefunk isismon_agent execute update []
  [mapc [funk [isismon_knowledge]
	      [if isismon_knowledge [have isismon_knowledge update]]]
	[get isismon_knowledge_ptypehash values]]
  nil]

[deftypefunk isismon_agent get retina_image_sequence []
  [get isis_agent retina_image_sequence]]

[deftypefunk isismon_agent execute save [filename]
  [terminal_format standard-terminal '\nIsisMon Agent: Saving ' filename '.']
  [have [get [get isis_agent as-chunk] deflated] save filename]
  [terminal_format standard-terminal '\nIsisMon Agent: Save agent complete.']]

[defunk isismon_agent-new_from_file [isismon_project filename]
  [terminal_format standard-terminal '\nIsisMon Agent: Loading ' filename '.']
  [let [[isis_agent_body [isis_agent_body-new_from_chunk [get isismon_project isis_world] [get [chunk-load filename] inflated]]]]
    [let [[this [new isismon_agent isismon_project isis_agent_body]]]
      [terminal_format standard-terminal '\nIsisMon Agent: Load agent complete.']
      this]]]
